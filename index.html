<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wahlergebnisse Berlin</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 100vh; }
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    var map = L.map('map').setView([52.52, 13.405], 10);
    
    var basemap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        minZoom: 12 // Basemap erst ab Zoom-Level 12 sichtbar
    }).addTo(map);

    // Zoom-Beschränkung
    map.setMinZoom(9);
    map.setMaxZoom(18);

    // Farbwerte für Parteien
    var partyColors = {
        "SPD": "#E3000F",
        "Grüne": "#1AA037",
        "CDU": "#000000",
        "LINKE": "#BE3075",
        "AfD": "#009EE0",
        "FDP": "#FFED00",
        "BSW": "#E98300",
        "Volt": "#5D2E8C",
        "FW": "#FF9E00",
        "Tierschutzpartei": "#0074A8",
        "MLPD": "#FF0000"
    };

    // Normalisierte Werte für Farbskala (händisch definiert)
    var minMaxValues = {
        "LINKE": [0.04, 0.5],
        "AfD": [0.02, 0.5],
        "SPD": [0.06, 0.26],
        "Grüne": [0.015, 0.41],
        "FDP": [0.004, 0.16],
        "BSW": [0.01, 0.16],
        "CDU": [0.031, 0.46]
    };

    function normalize(value, min, max) {
        return (value - min) / (max - min);
    }

    function getDominantParty(feature) {
        var parties = Object.keys(minMaxValues);
        var maxValue = 0;
        var dominantParty = "CDU";

        parties.forEach(party => {
            var rawValue = parseFloat(feature.properties[party + "inkBW"]);
            if (!isNaN(rawValue)) {
                var [min, max] = minMaxValues[party];
                var normalizedValue = normalize(rawValue, min, max);
                if (normalizedValue > maxValue) {
                    maxValue = normalizedValue;
                    dominantParty = party;
                }
            }
        });

        return { party: dominantParty, intensity: maxValue };
    }

    function style(feature) {
        var result = getDominantParty(feature);
        return {
            fillColor: partyColors[result.party],
            weight: 1,
            opacity: 1,
            color: 'white',
            fillOpacity: getPolygonOpacity(map.getZoom()) * result.intensity
        };
    }

    function getPolygonOpacity(zoomLevel) {
        return Math.max(0.2, 1 - (zoomLevel - 10) * 0.1);
    }

    var geojsonLayer = L.geoJSON(geojsonData, {
        style: style,
        onEachFeature: function(feature, layer) {
            layer.on({
                mouseover: function(e) {
                    var layer = e.target;
                    layer.setStyle({ weight: 3, color: '#666' });
                },
                mouseout: function(e) {
                    geojsonLayer.resetStyle(e.target);
                },
                click: function(e) {
                    var props = e.target.feature.properties;
                    var partyResult = getDominantParty(e.target.feature);
                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent(`<b>${props.Bezirk}</b><br>${partyResult.party}: ${(parseFloat(props[partyResult.party + "inkBW"]) * 100).toFixed(2)}%`)
                        .openOn(map);
                }
            });
        }
    }).addTo(map);

    map.on('zoomend', function() {
        var currentZoom = map.getZoom();
        geojsonLayer.setStyle({ fillOpacity: getPolygonOpacity(currentZoom) });
        basemap.setOpacity(currentZoom >= 12 ? 1 : 0);
    });

    // Legende hinzufügen
    var legend = L.control({ position: 'bottomleft' });
    legend.onAdd = function () {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML = '<strong>Parteifarben</strong><br>';
        for (var party in partyColors) {
            div.innerHTML += `<i style="background:${partyColors[party]}; width: 20px; height: 10px; display: inline-block;"></i> ${party}<br>`;
        }
        return div;
    };
    legend.addTo(map);

    // Suchfeld hinzufügen
    L.Control.geocoder().addTo(map);

</script>

</body>
</html>
