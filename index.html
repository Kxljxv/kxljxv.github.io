<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wahlergebnisse Karte</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    #map {
      width: 90%;
      height: 70vh;
      margin: 20px auto;
    }
    select {
      margin: 10px;
      padding: 5px;
      font-size: 1em;
    }
    .legend {
      background: white;
      padding: 10px;
      line-height: 1.5;
      font-size: 12px;
      border-radius: 5px;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <h1>Wahlergebnisse in Berlin</h1>
  
  <select id="partySelect">
    <option value="SPDinkBW">SPD</option>
    <option value="GrueninkBW">Grüne</option>
    <option value="CDUinkBW">CDU</option>
    <option value="LINKEinkBW">Die Linke</option>
    <option value="AfDinkBW">AfD</option>
    <option value="FDPinkBW">FDP</option>
    <option value="BSWinkBWB">Bündnis Sahra Wagenknecht</option>
  </select>

  <div id="map"></div>

  <p>Quellen: <a href="https://wahlen-berlin.de" target="_blank">wahlen-berlin.de</a>, <a href="https://daten.berlin.de" target="_blank">Open Data Portal Berlin</a></p>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  
  <script>
    var map = L.map('map', {
      minZoom: 10,
      maxZoom: 17,
      zoomControl: true
    }).setView([52.52, 13.405], 11);

    var baseMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
      opacity: 1
    }).addTo(map);

    // Farben der Parteien
    var partyColors = {
      "SPDinkBW": "#E3000F",
      "GrueninkBW": "#1AA037",
      "CDUinkBW": "#000000",
      "LINKEinkBW": "#A6006B",
      "AfDinkBW": "#0489DB",
      "FDPinkBW": "#FFEF00",
      "BSWinkBWB": "#008000"
    };

    // Wertebereiche der Parteien
    var partyRanges = {
      "SPDinkBW": { min: 0.06, max: 0.26 },
      "GrueninkBW": { min: 0.015, max: 0.41 },
      "CDUinkBW": { min: 0.031, max: 0.46 },
      "LINKEinkBW": { min: 0.04, max: 0.5 },
      "AfDinkBW": { min: 0.02, max: 0.5 },
      "FDPinkBW": { min: 0.004, max: 0.16 },
      "BSWinkBWB": { min: 0.01, max: 0.16 }
    };

    function getColor(value, party) {
      var range = partyRanges[party];
      var normValue = (value - range.min) / (range.max - range.min);
      normValue = Math.max(0, Math.min(1, normValue));
      return `rgba(${hexToRgb(partyColors[party]).join(',')}, ${normValue})`;
    }

    function hexToRgb(hex) {
      hex = hex.replace(/^#/, '');
      return [
        parseInt(hex.substring(0,2), 16),
        parseInt(hex.substring(2,4), 16),
        parseInt(hex.substring(4,6), 16)
      ];
    }

    function style(feature) {
      var party = document.getElementById("partySelect").value;
      var value = parseFloat(feature.properties[party]);
      return {
        fillColor: getColor(value, party),
        weight: 1,
        opacity: 1,
        color: "#ffffff",
        fillOpacity: 1 - (map.getZoom() - 10) / 7
      };
    }

    var geojsonLayer = L.geoJson(null, {
      style: style,
      onEachFeature: function (feature, layer) {
        layer.on("click", function () {
          var party = document.getElementById("partySelect").value;
          var percentage = (parseFloat(feature.properties[party]) * 100).toFixed(1);
          layer.bindPopup(`Bezirk: ${feature.properties.Bezirk}<br>${party}: ${percentage}%`).openPopup();
        });
        layer.on("mouseover", function () {
          layer.setStyle({ weight: 3, color: "black" });
        });
        layer.on("mouseout", function () {
          geojsonLayer.resetStyle(layer);
        });
      }
    }).addTo(map);

    fetch("geojson-data.json")
      .then(response => response.json())
      .then(data => geojsonLayer.addData(data))
      .catch(error => console.error("Fehler beim Laden der GeoJSON-Daten:", error));

    document.getElementById("partySelect").addEventListener("change", function () {
      geojsonLayer.setStyle(style);
    });

    L.Control.geocoder().addTo(map);

    var legend = L.control({ position: "bottomright" });
    legend.onAdd = function (map) {
      var div = L.DomUtil.create("div", "legend");
      div.innerHTML = "<b>Parteien</b><br>";
      for (var party in partyColors) {
        div.innerHTML += `<i style="background:${partyColors[party]}"></i> ${party}<br>`;
      }
      return div;
    };
    legend.addTo(map);

    map.on("zoomend", function () {
      geojsonLayer.setStyle(style);
    });

  </script>
</body>
</html>
