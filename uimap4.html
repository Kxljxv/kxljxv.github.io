<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Bundestagswahl 2025: Alle Wahlergebnisse in Berlin auf einer Karte | Tagesspiegel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tagesspiegel Fonts (Beispiel – diese Links können ggf. angepasst werden) -->
  <link rel="stylesheet" href="https://interaktiv.tagesspiegel.de/lab/assets/fonts/abril.css">
  <link rel="stylesheet" href="https://interaktiv.tagesspiegel.de/lab/assets/fonts/franklin_gothic_fs_v3.css">
  <!-- Tailwind CSS und Flowbite -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/flowbite@1.6.5/dist/flowbite.min.css" rel="stylesheet">
  <!-- Maplibre CSS -->
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet">
  <style>
    /* Zentrale Farbkodierung und Design-Parameter (an einer Stelle änderbar) */
    :root {
      --bg-color: #ffffff;           /* Gesamtseitenhintergrund */
      --primary-color: #000000;        /* Haupttext */
      --secondary-color: #555555;      /* Sekundärtexte */
      --accent-color: #a3512b;         /* Akzentfarbe (z. B. für Marker und Highlights) */
      --control-bg: #f2f2f2;           /* Hintergrundfarbe von UI-Elementen */
      --border-color: #ddd;            /* Rahmenfarbe */
    }
    body {
      background-color: var(--bg-color);
      color: var(--primary-color);
      font-family: "Franklin Gothic Medium", "Arial Narrow", Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      text-align: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    .main-container {
      display: flex;
      max-width: 1200px;
      margin: 1rem auto;
      gap: 1rem;
    }
    #mapContainer {
      position: relative;
      width: 65%;
      height: 70vh;
      border: 1px solid var(--border-color);
    }
    #sidebar {
      width: 35%;
      padding: 1rem;
      border: 1px solid var(--border-color);
      background-color: var(--control-bg);
    }
    #searchField {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      margin-bottom: 1rem;
    }
    #resultPanel {
      background-color: var(--control-bg);
      padding: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      min-height: 200px;
    }
    #yearSelection {
      text-align: center;
      margin: 1rem auto;
      padding: 0.5rem;
      background-color: var(--control-bg);
      border: 1px solid var(--border-color);
      border-radius: 9999px;
      display: inline-block;
    }
    #yearSelection label {
      margin: 0 0.5rem;
      cursor: pointer;
      font-weight: 500;
    }
  </style>
  <script>
    /* JS-Farbkonstanten */
    const COLORS = {
      accent: "#a3512b"
    };
  </script>
</head>
<body>
  <header>
    <h1>Bundestagswahl 2025: Alle Wahlergebnisse in Berlin auf einer Karte</h1>
    <p>Interaktive Darstellung der Wahlergebnisse</p>
  </header>
  <div class="main-container">
    <div id="mapContainer">
      <div id="map" class="w-full h-full"></div>
    </div>
    <div id="sidebar">
      <input type="text" id="searchField" placeholder="Suche nach Ort, Bezirk...">
      <div id="partySelection">
        <h2>Partei wählen</h2>
        <select id="partySelect" class="w-full p-2 border rounded">
          <!-- Optionen werden per JavaScript eingefügt -->
        </select>
      </div>
      <div id="resultPanel">
        <h2>Ergebnisse</h2>
        <div id="statsContent">
          <p>Wählen Sie einen Bereich auf der Karte, um die Ergebnisse anzuzeigen.</p>
        </div>
      </div>
    </div>
  </div>
  <div id="yearSelection">
    <label>
      <input type="radio" name="year" value="2021"> 2021
    </label>
    <label>
      <input type="radio" name="year" value="2025" checked> 2025
    </label>
  </div>
  <!-- Maplibre und Flowbite Skripte -->
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/flowbite@1.6.5/dist/flowbite.js"></script>
  <script>
    // Parteianzeige und Datensätze (übernommen aus unserem bisherigen Projekt)
    var partyDisplayNames = {
      "WahlbeteiligunginkBW": "Wahlbeteiligung",
      "SPDinkBW": "SPD",
      "GrueninkBW": "Grüne",
      "CDUinkBW": "CDU",
      "LINKEinkBW": "Die Linke",
      "AfDinkBW": "AfD",
      "FDPinkBW": "FDP",
      "BSWinkBWB": "BSW",
      "PARTEIMENSCHUMWELTTIERSCHUTZinkBW": "Tierschutzpartei",
      "VoltDeutschlandinkBW": "Volt",
      "FWinkBW": "FW",
      "MLPDinkBW": "MLPD"
    };

    var dataset2025 = {
      url: 'https://kxljxv.github.io/wahlergebnisse2025.json',
      partyRanges: {
        "WahlbeteiligunginkBW": { min: 0.454105275, max: 0.98 },
        "SPDinkBW": { min: 0.06, max: 0.39984263 },
        "GrueninkBW": { min: 0.015, max: 0.541414141 },
        "CDUinkBW": { min: 0.025714286, max: 0.46 },
        "LINKEinkBW": { min: 0.011583012, max: 0.5 },
        "AfDinkBW": { min: 0.005931198, max: 0.5 },
        "FDPinkBW": { min: 0.004, max: 0.268841395 },
        "BSWinkBWB": { min: 0.012, max: 0.16 },
        "PARTEIMENSCHUMWELTTIERSCHUTZinkBW": { min: 0.0, max: 0.085704944 },
        "VoltDeutschlandinkBW": { min: 0.0, max: 0.029 },
        "FWinkBW": { min: 0.0, max: 0.034937014 },
        "MLPDinkBW": { min: 0.0, max: 0.012658228 }
      },
      availableParties: [
        "WahlbeteiligunginkBW", "SPDinkBW", "GrueninkBW", "CDUinkBW", "LINKEinkBW",
        "AfDinkBW", "FDPinkBW", "BSWinkBWB", "PARTEIMENSCHUMWELTTIERSCHUTZinkBW",
        "VoltDeutschlandinkBW", "FWinkBW", "MLPDinkBW"
      ]
    };

    var dataset2021 = {
      url: 'https://kxljxv.github.io/wahlergebnisse2021.json',
      partyRanges: {
        "WahlbeteiligunginkBW": { min: 0.454105275, max: 0.98 },
        "SPDinkBW": { min: 0.06, max: 0.39984263 },
        "GrueninkBW": { min: 0.015, max: 0.541414141 },
        "CDUinkBW": { min: 0.025714286, max: 0.46 },
        "LinkeinkBW": { min: 0.011583012, max: 0.5 },
        "AfDinkBW": { min: 0.005931198, max: 0.5 },
        "FDPinkBW": { min: 0.004, max: 0.268841395 },
        "PARTEIMENSCHUMWELTTIERSCHUTZinkBW": { min: 0.0, max: 0.085704944 },
        "VoltinkBW": { min: 0.0, max: 0.029 },
        "FWinkBW": { min: 0.0, max: 0.034937014 },
        "MLPDinkBW": { min: 0.0, max: 0.012658228 }
      },
      availableParties: [
        "WahlbeteiligunginkBW", "SPDinkBW", "GrueninkBW", "CDUinkBW", "LinkeinkBW",
        "AfDinkBW", "FDPinkBW", "PARTEIMENSCHUMWELTTIERSCHUTZinkBW",
        "VoltinkBW", "FWinkBW", "MLPDinkBW"
      ]
    };

    var currentDataset = dataset2025;
    var currentParty = "WahlbeteiligunginkBW";
    var geojsonData = null;

    // Initialisiere Maplibre
    var map = new maplibregl.Map({
      container: 'map',
      style: 'https://kxljxv.github.io/bm_web_gry_7.json',
      center: [13.40, 52.52],
      zoom: 10,
      minZoom: 10,
      maxBounds: [[13.0884, 52.3383], [13.7612, 52.6755]],
      attributionControl: false
    });
    map.dragRotate.disable();
    map.touchZoomRotate.disableRotation();

    // Lade GeoJSON-Daten und setze Füllfarben basierend auf der gewählten Partei
    function loadGeoJson() {
      fetch(currentDataset.url)
        .then(response => response.json())
        .then(data => {
          geojsonData = data;
          geojsonData.features.forEach(function(feature) {
            var rawValue = parseFloat(feature.properties[currentParty].replace(',', '.'));
            var range = currentDataset.partyRanges[currentParty];
            var normalized = (rawValue - range.min) / (range.max - range.min);
            normalized = Math.max(0, Math.min(1, normalized));
            // einfache Farbinterpolation zwischen Weiß und Accentfarbe
            var r = Math.round(255 + (parseInt(COLORS.accent.substring(1,3),16) - 255) * normalized);
            var g = Math.round(255 + (parseInt(COLORS.accent.substring(3,5),16) - 255) * normalized);
            var b = Math.round(255 + (parseInt(COLORS.accent.substring(5,7),16) - 255) * normalized);
            feature.properties.fillColor = "rgb(" + r + "," + g + "," + b + ")";
          });
          if (map.getSource('geojson-layer')) {
            map.getSource('geojson-layer').setData(geojsonData);
          } else {
            map.addSource('geojson-layer', { type: 'geojson', data: geojsonData });
            var firstLayerId = map.getStyle().layers[0].id;
            map.addLayer({
              id: 'geojson-fill',
              type: 'fill',
              source: 'geojson-layer',
              paint: {
                'fill-color': ['get', 'fillColor'],
                'fill-opacity': [
                  "interpolate", ["linear"], ["zoom"], 10, 1, 16, 1
                ]
              }
            }, firstLayerId);
          }
        })
        .catch(error => console.error('Fehler beim Laden der GeoJSON-Daten:', error));
    }
    loadGeoJson();

    // Fülle die Parteiauswahl im Sidebar-Dropdown
    function populatePartySelect() {
      var select = document.getElementById('partySelect');
      select.innerHTML = "";
      currentDataset.availableParties.forEach(function(key) {
        var option = document.createElement('option');
        option.value = key;
        option.text = partyDisplayNames[key] || key;
        if (key === currentParty) option.selected = true;
        select.appendChild(option);
      });
    }
    populatePartySelect();

    document.getElementById('partySelect').addEventListener('change', function(e) {
      currentParty = e.target.value;
      populatePartySelect();
      loadGeoJson();
      document.getElementById('statsContent').innerHTML = "<p>Klicken Sie auf einen Bereich in der Karte, um die Ergebnisse anzuzeigen.</p>";
    });

    // Jahresauswahl unten: Wechsle den Datensatz und lade die Daten neu
    document.querySelectorAll('input[name="year"]').forEach(input => {
      input.addEventListener('change', function(e) {
        var selectedYear = e.target.value;
        if (selectedYear === "2025") currentDataset = dataset2025;
        else if (selectedYear === "2021") currentDataset = dataset2021;
        populatePartySelect();
        loadGeoJson();
      });
    });

    // Suchfeld: Filtere die GeoJSON-Daten basierend auf dem Bezirk (Eigenschaft "UWB")
    document.getElementById('searchField').addEventListener('input', function(e) {
      var query = e.target.value.toLowerCase();
      if (!geojsonData) return;
      var filteredData = JSON.parse(JSON.stringify(geojsonData));
      filteredData.features = filteredData.features.filter(function(feature) {
        return feature.properties.UWB.toLowerCase().includes(query);
      });
      if (map.getSource('geojson-layer')) {
        map.getSource('geojson-layer').setData(filteredData);
      }
    });

    // Statt Popups: Beim Klick auf einen Bereich in der Karte wird im Sidebar-Panel aktualisiert und ein Marker gesetzt
    var marker;
    map.on('click', 'geojson-fill', function(e) {
      if (!e.features.length) return;
      var feature = e.features[0];
      var rawValue = parseFloat(feature.properties[currentParty].replace(',', '.'));
      var percent = (rawValue * 100).toFixed(2) + '%';
      var content = "<h3>" + feature.properties.UWB + "</h3>" +
                    "<p>Wahlbeteiligung: " + (parseFloat(feature.properties.WahlbeteiligunginkBW.replace(',', '.')) * 100).toFixed(2) + "%</p>" +
                    "<p>" + (partyDisplayNames[currentParty] || currentParty) + ": " + percent + "</p>";
      document.getElementById('statsContent').innerHTML = content;
      if (marker) marker.remove();
      marker = new maplibregl.Marker({ color: COLORS.accent })
        .setLngLat(e.lngLat)
        .addTo(map);
    });
    map.on('mouseenter', 'geojson-fill', function() { map.getCanvas().style.cursor = 'pointer'; });
    map.on('mouseleave', 'geojson-fill', function() { map.getCanvas().style.cursor = ''; });
  </script>
</body>
</html>
