<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wahlergebnisse in Berlin – Bundestagswahl 2025</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Flowbite CSS (kostenlose Version) -->
  <link href="https://unpkg.com/flowbite@1.6.5/dist/flowbite.min.css" rel="stylesheet" />
  <!-- Maplibre CSS -->
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  
  <!-- Zentrale Farbkodierung und globale Styles im Tagesspiegel‑Stil -->
  <style>
    :root {
      --bg-color: #ffffff; /* Seitenhintergrund */
      --control-bg-color: #f7f7f7; /* Hintergründe von UI-Elementen */
      --accent-color: #a3512b;
      --text-primary: #000000;
      --text-secondary: #666666;
      --border-color: #ddd;
      --popup-bg: #f7f7f7;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-primary);
      font-family: "Franklin Gothic", "Arial", sans-serif;
    }
    /* Header */
    header {
      padding: 1rem 0;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1rem;
    }
    header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    /* Container: Zwei Spalten – Karte links, Sidebar rechts */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    @media (min-width: 768px) {
      .map-and-sidebar {
        display: flex;
        gap: 1rem;
      }
      .map-column {
        flex: 7;
        position: relative;
      }
      .sidebar-column {
        flex: 3;
        background-color: var(--control-bg-color);
        border: 1px solid var(--border-color);
        padding: 1rem;
        border-radius: 0.5rem;
        height: 100%;
      }
    }
    /* Map container – übernimmt unsere Karte (unsere GeoJSON-Daten) */
    #mapContainer {
      width: 100%;
      height: 500px;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      position: relative;
      overflow: hidden;
    }
    /* Overlay-Controls auf der Karte (Zoom, Standort, Vollbild) */
    .map-control {
      position: absolute;
      background-color: var(--control-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 9999px;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .map-control:hover {
      background-color: var(--accent-color);
    }
    /* Positionierung der Map Controls */
    #zoomControls {
      top: 0.5rem;
      right: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 10;
    }
    #fullscreenButton {
      top: 0.5rem;
      left: 0.5rem;
      z-index: 10;
    }
    #locateBtn {
      /* wird zusammen mit den Zoom-Buttons platziert */
    }
    /* Suchfeld im Sidebar */
    .search-field input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      font-size: 1rem;
    }
    /* Statistikbereich */
    .statistic-panel {
      margin-top: 1rem;
    }
    .statistic-panel h2 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
    }
    /* Jahresauswahl (unten) */
    .year-selection {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    .year-selection label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- Kopfbereich -->
  <header>
    <h1>Bundestagswahl 2025: Wahlergebnisse in Berlin</h1>
    <p style="color: var(--text-secondary);">Interaktive Karte – wählen Sie eine Partei, suchen Sie nach Ihrem Wahlbezirk und sehen Sie die aktuellen Statistiken.</p>
  </header>
  
  <!-- Hauptcontainer -->
  <div class="main-container">
    <!-- Obere Steuerungsleiste: Partei‑Auswahl (Dropdown) -->
    <div class="flex flex-col md:flex-row items-center gap-4">
      <!-- Parteiauswahl (wie in unseren bisherigen Lösungen) -->
      <div class="relative">
        <button id="dropdownPartyButton" data-dropdown-toggle="dropdownParty" class="btn-control">
          Partei: <span id="selectedParty">Wahlbeteiligung</span>
          <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="dropdownParty" class="dropdown-menu absolute mt-2 w-48 hidden">
          <div id="dropdownPartyContent" class="py-2">
            <!-- Optionen werden per JS eingefügt -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- Flex-Container: Linke Spalte Karte, Rechte Spalte Sidebar -->
    <div class="map-and-sidebar flex flex-col md:flex-row gap-4">
      <!-- Karte -->
      <div class="map-column">
        <div id="mapContainer">
          <div id="map" class="w-full h-full rounded"></div>
          <!-- Custom Map Controls als Overlay -->
          <div id="zoomControls" class="absolute">
            <div id="zoomInBtn" class="map-control" title="Zoom in">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path>
              </svg>
            </div>
            <div id="zoomOutBtn" class="map-control" title="Zoom out">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4"></path>
              </svg>
            </div>
            <div id="locateBtn" class="map-control" title="Standort anzeigen">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8a4 4 0 100 8 4 4 0 000-8z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.24 7.76a6 6 0 11-8.48 0 6 6 0 018.48 0z"/>
              </svg>
            </div>
          </div>
          <!-- Vollbild-Button -->
          <div id="fullscreenButton" class="map-control" title="Vollbild">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4h4M20 16v4h-4M4 16v4h4M20 8V4h-4"></path>
            </svg>
          </div>
        </div>
      </div>
      <!-- Sidebar: Suchfeld, Statistik & Ergebnisse -->
      <div class="sidebar-column">
        <!-- Suchfeld -->
        <div class="search-field mb-4">
          <input type="text" id="searchInput" placeholder="Nach Wahlbezirk suchen..." />
        </div>
        <!-- Statistikbereich -->
        <div class="statistic-panel">
          <h2>Ergebnisse</h2>
          <div id="resultDetails">
            <!-- Hier werden die Details zum ausgewählten Wahlbezirk angezeigt -->
            <p>Bitte klicken Sie auf einen Wahlbezirk in der Karte oder suchen Sie über das Suchfeld.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Jahresauswahl (horizontal) unterhalb der Karte -->
    <div class="year-selection">
      <label class="flex items-center gap-2">
        <input type="radio" name="fsYear" value="2021" class="form-radio" style="accent-color: var(--accent-color);">
        <span>2021</span>
      </label>
      <label class="flex items-center gap-2">
        <input type="radio" name="fsYear" value="2025" class="form-radio" style="accent-color: var(--accent-color);" checked>
        <span>2025</span>
      </label>
    </div>
  </div>
  
  <!-- Skripte -->
  <!-- Maplibre -->
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <!-- Flowbite JS -->
  <script src="https://unpkg.com/flowbite@1.6.5/dist/flowbite.js"></script>
  
  <script>
    // Parteianzeige, Mapping und Farbgradienten (wie in früheren Beispielen)
    var partyDisplayNames = {
      "WahlbeteiligunginkBW": "Wahlbeteiligung",
      "SPDinkBW": "SPD",
      "GrueninkBW": "Grüne",
      "CDUinkBW": "CDU",
      "LINKEinkBW": "Die Linke",
      "LinkeinkBW": "Die Linke",
      "AfDinkBW": "AfD",
      "FDPinkBW": "FDP",
      "BSWinkBWB": "BSW",
      "PARTEIMENSCHUMWELTTIERSCHUTZinkBW": "Tierschutzpartei",
      "VoltDeutschlandinkBW": "Volt",
      "VoltinkBW": "Volt",
      "FWinkBW": "FW",
      "MLPDinkBW": "MLPD"
    };
    var partyMapping = {
      "LINKEinkBW": "LinkeinkBW",
      "VoltDeutschlandinkBW": "VoltinkBW",
      "LinkeinkBW": "LINKEinkBW",
      "VoltinkBW": "VoltDeutschlandinkBW"
    };
    var partyColorGradients = {
      "WahlbeteiligunginkBW": { min: "#FFF7F5", max: "#002617" },
      "SPDinkBW": { min: "#FFF7F5", max: "#570000" },
      "GrueninkBW": { min: "#FFF7F5", max: "#004F00" },
      "CDUinkBW": { min: "#FFF7F5", max: "#09090A" },
      "LINKEinkBW": { min: "#FFF7F5", max: "#8F0354" },
      "LinkeinkBW": { min: "#FFF7F5", max: "#8F0354" },
      "AfDinkBW": { min: "#FFF7F5", max: "#002B9C" },
      "FDPinkBW": { min: "#FFF7F5", max: "#5E4A00" },
      "BSWinkBWB": { min: "#FFF7F5", max: "#571334" },
      "PARTEIMENSCHUMWELTTIERSCHUTZinkBW": { min: "#FFF7F5", max: "#00454D" },
      "VoltDeutschlandinkBW": { min: "#FFF7F5", max: "#462270" },
      "VoltinkBW": { min: "#FFF7F5", max: "#462270" },
      "FWinkBW": { min: "#FFF7F5", max: "#9C4900" },
      "MLPDinkBW": { min: "#FFF7F5", max: "#8C142A" }
    };
    
    var dataset2025 = {
      url: 'https://kxljxv.github.io/wahlergebnisse2025.json',
      partyRanges: {
        "WahlbeteiligunginkBW": { min: 0.454105275, max: 0.98 },
        "SPDinkBW": { min: 0.06, max: 0.39984263 },
        "GrueninkBW": { min: 0.015, max: 0.541414141 },
        "CDUinkBW": { min: 0.025714286, max: 0.46 },
        "LINKEinkBW": { min: 0.011583012, max: 0.5 },
        "AfDinkBW": { min: 0.005931198, max: 0.5 },
        "FDPinkBW": { min: 0.004, max: 0.268841395 },
        "BSWinkBWB": { min: 0.012, max: 0.16 },
        "PARTEIMENSCHUMWELTTIERSCHUTZinkBW": { min: 0.0, max: 0.085704944 },
        "VoltDeutschlandinkBW": { min: 0.0, max: 0.029 },
        "FWinkBW": { min: 0.0, max: 0.034937014 },
        "MLPDinkBW": { min: 0.0, max: 0.012658228 }
      },
      availableParties: [
        "WahlbeteiligunginkBW", "SPDinkBW", "GrueninkBW", "CDUinkBW", "LINKEinkBW",
        "AfDinkBW", "FDPinkBW", "BSWinkBWB", "PARTEIMENSCHUMWELTTIERSCHUTZinkBW",
        "VoltDeutschlandinkBW", "FWinkBW", "MLPDinkBW"
      ]
    };
    
    var dataset2021 = {
      url: 'https://kxljxv.github.io/wahlergebnisse2021.json',
      partyRanges: {
        "WahlbeteiligunginkBW": { min: 0.454105275, max: 0.98 },
        "SPDinkBW": { min: 0.06, max: 0.39984263 },
        "GrueninkBW": { min: 0.015, max: 0.541414141 },
        "CDUinkBW": { min: 0.025714286, max: 0.46 },
        "LinkeinkBW": { min: 0.011583012, max: 0.5 },
        "AfDinkBW": { min: 0.005931198, max: 0.5 },
        "FDPinkBW": { min: 0.004, max: 0.268841395 },
        "PARTEIMENSCHUMWELTTIERSCHUTZinkBW": { min: 0.0, max: 0.085704944 },
        "VoltinkBW": { min: 0.0, max: 0.029 },
        "FWinkBW": { min: 0.0, max: 0.034937014 },
        "MLPDinkBW": { min: 0.0, max: 0.012658228 }
      },
      availableParties: [
        "WahlbeteiligunginkBW", "SPDinkBW", "GrueninkBW", "CDUinkBW", "LinkeinkBW",
        "AfDinkBW", "FDPinkBW", "PARTEIMENSCHUMWELTTIERSCHUTZinkBW",
        "VoltinkBW", "FWinkBW", "MLPDinkBW"
      ]
    };
    
    var currentDataset = dataset2025;
    var currentParty = "WahlbeteiligunginkBW";
    var geojsonData = null;
    var selectedMarker = null;
    
    function hexToRgb(hex) { 
      hex = hex.replace(/^#/, '');
      if (hex.length === 3) { hex = hex.split('').map(c => c + c).join(''); }
      var bigint = parseInt(hex, 16);
      return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
    }
    function rgbToHex(r, g, b) {
      return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
    }
    function interpolateColors(color1Hex, color2Hex, value) {
      var color1 = hexToRgb(color1Hex);
      var color2 = hexToRgb(color2Hex);
      var r = Math.round(color1.r + (color2.r - color1.r) * value);
      var g = Math.round(color1.g + (color2.g - color1.g) * value);
      var b = Math.round(color1.b + (color2.b - color1.b) * value);
      return rgbToHex(r, g, b);
    }
    function getColor(rawValue, party) {
      var range = currentDataset.partyRanges[party];
      var normalized = (rawValue - range.min) / (range.max - range.min);
      normalized = Math.max(0, Math.min(1, normalized));
      var gradient = partyColorGradients[party];
      if (!gradient) return "#CCCCCC";
      return interpolateColors(gradient.min, gradient.max, normalized);
    }
    function updateGeojsonData(data) {
      data.features.forEach(function(feature) {
        var rawValue = parseFloat(feature.properties[currentParty].replace(',', '.'));
        feature.properties.fillColor = getColor(rawValue, currentParty);
      });
      return data;
    }
    
    // Map initialisieren
    var map = new maplibregl.Map({
      container: 'map',
      style: 'https://kxljxv.github.io/bm_web_gry_7.json',
      center: [13.40, 52.52],
      zoom: 10,
      minZoom: 10,
      maxBounds: [[13.0884, 52.3383], [13.7612, 52.6755]],
      attributionControl: false
    });
    map.dragRotate.disable();
    map.touchZoomRotate.disableRotation();
    
    // Custom Map Controls
    document.getElementById("zoomInBtn").addEventListener("click", function() { map.zoomIn(); });
    document.getElementById("zoomOutBtn").addEventListener("click", function() { map.zoomOut(); });
    document.getElementById("locateBtn").addEventListener("click", function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const coords = [position.coords.longitude, position.coords.latitude];
          map.flyTo({ center: coords });
          if (selectedMarker) { selectedMarker.remove(); }
          selectedMarker = new maplibregl.Marker({ color: COLORS.accent })
            .setLngLat(coords)
            .addTo(map);
          updateSidebar({ UWB: "Ihr Standort", 
                          WahlbeteiligunginkBW: (position.coords.accuracy/1000).toFixed(2) + "%" });
        });
      } else {
        alert('Geolocation wird in diesem Browser nicht unterstützt.');
      }
    });
    
    // Beim Klick auf ein GeoJSON-Feature: Marker setzen und Sidebar aktualisieren
    map.on('click', 'geojson-fill', function(e) {
      if (!e.features.length) return;
      var feature = e.features[0];
      if (selectedMarker) { selectedMarker.remove(); }
      selectedMarker = new maplibregl.Marker({ color: COLORS.accent })
        .setLngLat(e.lngLat)
        .addTo(map);
      // Sidebar mit den Ergebnissen aktualisieren
      updateSidebar(feature.properties);
    });
    
    // Suche: Filtert die GeoJSON-Daten nach Wahlbezirk (UWB) und setzt Marker, falls gefunden
    document.getElementById('searchInput').addEventListener('keyup', function(e) {
      var query = e.target.value.trim().toLowerCase();
      if (!geojsonData) return;
      var found = geojsonData.features.find(f => f.properties.UWB.toLowerCase().includes(query));
      if (found) {
        map.flyTo({ center: found.geometry.coordinates[0][0], zoom: 12 });
        if (selectedMarker) { selectedMarker.remove(); }
        selectedMarker = new maplibregl.Marker({ color: COLORS.accent })
          .setLngLat(found.geometry.coordinates[0][0])
          .addTo(map);
        updateSidebar(found.properties);
      }
    });
    
    // Funktion zum Aktualisieren des Sidebar-Inhalts
    function updateSidebar(properties) {
      var details = document.getElementById('resultDetails');
      details.innerHTML = '<h3>' + properties.UWB + '</h3>' +
                          '<p>Wahlbeteiligung: ' + (parseFloat(properties.WahlbeteiligunginkBW.replace(",", ".")) * 100).toFixed(2) + '%</p>' +
                          '<p>Ergebnis (' + (partyDisplayNames[currentParty] || currentParty) + '): ' +
                          properties[currentParty] + '</p>';
    }
    
    // Partei-Dropdown befüllen
    function populatePartyDropdown() {
      var partyContainer = document.getElementById('dropdownPartyContent');
      partyContainer.innerHTML = "";
      currentDataset.availableParties.forEach(function(key) {
        var label = document.createElement('label');
        label.className = "flex items-center px-4 py-2 cursor-pointer";
        label.innerHTML = `<input type="radio" name="party" value="${key}" class="form-radio" style="accent-color: var(--accent-color);" ${key === currentParty ? "checked" : ""}>
                           <span class="ml-2">${partyDisplayNames[key] || key}</span>`;
        partyContainer.appendChild(label);
      });
      document.getElementById('selectedParty').innerText = partyDisplayNames[currentParty] || currentParty;
    }
    
    document.addEventListener('change', function(e) {
      if (e.target.name === 'party') {
        currentParty = e.target.value;
        document.getElementById('selectedParty').innerText = partyDisplayNames[currentParty] || currentParty;
        if (geojsonData) {
          geojsonData = updateGeojsonData(geojsonData);
          if (map.getSource('geojson-layer')) { map.getSource('geojson-layer').setData(geojsonData); }
        }
      }
      if (e.target.name === 'year') {
        var selectedYear = e.target.value;
        document.getElementById('selectedYear').innerText = selectedYear;
        currentDataset = selectedYear === "2025" ? dataset2025 : dataset2021;
        populatePartyDropdown();
        loadGeoJson();
      }
    });
    
    // GeoJSON-Daten laden und als Layer einfügen
    function loadGeoJson() {
      fetch(currentDataset.url)
        .then(response => response.json())
        .then(data => {
          geojsonData = updateGeojsonData(data);
          if (map.getSource('geojson-layer')) {
            map.getSource('geojson-layer').setData(geojsonData);
          } else {
            map.addSource('geojson-layer', { type: 'geojson', data: geojsonData });
            var firstLayerId = map.getStyle().layers[0].id;
            map.addLayer({
              id: 'geojson-fill',
              type: 'fill',
              source: 'geojson-layer',
              paint: {
                'fill-color': ['get', 'fillColor'],
                'fill-opacity': [
                  "interpolate",
                  ["linear"],
                  ["zoom"],
                  10, 1,
                  16, 1
                ]
              }
            }, firstLayerId);
          }
        })
        .catch(error => console.error('Fehler beim Laden der GeoJSON-Daten:', error));
    }
    
    populatePartyDropdown();
    map.on('load', loadGeoJson);
    
    // Jahresauswahl: horizontales Radio-Group-Event (oben in der Sidebar und unten)
    document.querySelectorAll('input[name="fsYear"]').forEach(input => {
      input.addEventListener('change', function(e) {
        const selectedYear = e.target.value;
        document.getElementById('selectedYear').innerText = selectedYear;
        currentDataset = selectedYear === "2025" ? dataset2025 : dataset2021;
        loadGeoJson();
      });
    });
  </script>
</body>
</html>
