<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Wahlbezirk-Auswahl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- MapLibre GL CSS -->
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #ffffff;
    }
    /* Die Karte füllt den gesamten Viewport */
    #map {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- MapLibre GL JS -->
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    let geojsonData;
    let csvData = [];
    let map;
    let selectedFeatureId = null;

    // Einfaches CSV-Parsing (Header in erster Zeile)
    function parseCSV(text) {
      const lines = text.trim().split("\n");
      const headers = lines[0].split(",");
      const result = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(",");
        const obj = {};
        headers.forEach((header, index) => {
          obj[header.trim()] = values[index] ? values[index].trim() : "";
        });
        result.push(obj);
      }
      return result;
    }

    // Lade GeoJSON und CSV, und verknüpfe beide Datensätze anhand der Eigenschaft "ID"
    async function loadData() {
      try {
        const geoRes = await fetch("https://kxljxv.github.io/wahlergebnisse/map.json");
        if (!geoRes.ok) throw new Error("GeoJSON konnte nicht geladen werden.");
        geojsonData = await geoRes.json();
        console.log("GeoJSON erfolgreich geladen.");
      } catch (error) {
        console.error("Fehler beim Laden der GeoJSON:", error);
      }
      
      try {
        const csvRes = await fetch("https://kxljxv.github.io/wahlergebnisse/ergebnisse.csv");
        if (!csvRes.ok) throw new Error("CSV konnte nicht geladen werden.");
        const csvText = await csvRes.text();
        csvData = parseCSV(csvText);
        console.log("CSV erfolgreich geladen.");
      } catch (error) {
        console.error("Fehler beim Laden der CSV:", error);
      }
      
      // Verknüpfe CSV-Daten mit den GeoJSON-Features anhand der Eigenschaft "ID"
      if (geojsonData && csvData.length > 0) {
        geojsonData.features.forEach(feature => {
          const id = feature.properties.ID;
          const row = csvData.find(r => r.ID === id);
          if (row) {
            // Merge CSV-Zeile in die Feature-Properties
            feature.properties = Object.assign({}, feature.properties, row);
          }
          // Standard-Füllfarbe (kannst du anpassen)
          feature.properties.fillColor = "#cccccc";
        });
      }
      initMap();
    }

    function initMap() {
      map = new maplibregl.Map({
        container: "map",
        style: "https://kxljxv.github.io/bm_web_gry_7.json",
        center: [13.4050, 52.5200], // Zentriert auf Berlin
        zoom: 10,
        pitchWithRotate: false,
        dragRotate: false
      });
      
      // Rotation/Tilt per Touch deaktivieren
      map.touchZoomRotate.disableRotation();

      // Navigation- und Geolocation-Buttons von MapLibre
      map.addControl(new maplibregl.NavigationControl());
      map.addControl(new maplibregl.GeolocateControl({
         positionOptions: { enableHighAccuracy: true },
         trackUserLocation: true,
         showUserLocation: true
      }));

      map.on("load", function() {
        // GeoJSON-Layer hinzufügen
        map.addSource("wahlbezirke", { type: "geojson", data: geojsonData });
        map.addLayer({
          id: "wahlbezirke-fill",
          type: "fill",
          source: "wahlbezirke",
          layout: {},
          paint: {
            "fill-color": ["get", "fillColor"],
            "fill-opacity": 1
          }
        }, map.getStyle().layers[0].id);
        console.log("Karte und Layer erfolgreich initialisiert.");

        // Klick-Event für die Polygone
        map.on("click", "wahlbezirke-fill", function(e) {
          if (e.features.length > 0) {
            const feature = e.features[0];
            selectedFeatureId = feature.properties.ID;
            updateSelection();
            
            // Erstelle den Ausgabestring mit der ID
            const outputString = "Ausgewählter Wahlbezirk ID: " + selectedFeatureId;
            console.log(outputString);
            
            // Sende den String an die einbettende Seite (wenn als IFrame eingebettet)
            if (window.parent) {
              window.parent.postMessage({ selectedID: selectedFeatureId }, "*");
            }
          }
        });

        // Klick außerhalb eines Polygons: Auswahl zurücksetzen
        map.on("click", function(e) {
          const features = map.queryRenderedFeatures(e.point, { layers: ["wahlbezirke-fill"] });
          if (!features.length) {
            selectedFeatureId = null;
            removeSelectionLayer();
          }
        });
      });
    }

    // Hebt den ausgewählten Wahlbezirk hervor (z. B. durch schwarzen Rand)
    function updateSelection() {
      removeSelectionLayer();
      map.addLayer({
        id: "selected-outline",
        type: "line",
        source: "wahlbezirke",
        filter: ["==", ["get", "ID"], selectedFeatureId],
        layout: {},
        paint: {
          "line-color": "#000000",
          "line-width": 2
        }
      });
    }
    function removeSelectionLayer() {
      if (map.getLayer("selected-outline")) {
        map.removeLayer("selected-outline");
      }
    }

    // Starte den Ladevorgang
    loadData();
  </script>
</body>
</html>
