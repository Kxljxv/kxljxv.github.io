<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Wahlergebnisse Karte Berlin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 100vh; }
    #selected-id {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.8);
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="selected-id">Keine Auswahl</div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    let geojsonData;
    let csvData = [];
    let map;
    let selectedFeatureId = null;
    let selectedYear = "2025"; 
    let selectedParty = "gewinner"; 

    const columns = {
      "21AFD": { minColor: "#FFE5E5", maxColor: "#FF0000", minValue: 0, maxValue: 40 },
      "21GRUENE": { minColor: "#E0FFF4", maxColor: "#2A9D8F", minValue: 0, maxValue: 50 },
      "21LINKE": { minColor: "#FFE6FF", maxColor: "#D291BC", minValue: 0, maxValue: 50 },
      "21SPD": { minColor: "#E0FFF4", maxColor: "#4CAF50", minValue: 0, maxValue: 60 },
      "21CDU": { minColor: "#E3F2FD", maxColor: "#1976D2", minValue: 0, maxValue: 50 },
      "25AFD": { minColor: "#FFE5E5", maxColor: "#FF0000", minValue: 0, maxValue: 40 },
      "25GRUENE": { minColor: "#E0FFF4", maxColor: "#2A9D8F", minValue: 0, maxValue: 50 },
      "25LINKE": { minColor: "#FFE6FF", maxColor: "#D291BC", minValue: 0, maxValue: 50 },
      "25SPD": { minColor: "#E0FFF4", maxColor: "#4CAF50", minValue: 0, maxValue: 60 },
      "25CDU": { minColor: "#E3F2FD", maxColor: "#1976D2", minValue: 0, maxValue: 50 }
    };

    function interpolateColor(color1, color2, factor) {
      const c1 = parseInt(color1.slice(1), 16);
      const c2 = parseInt(color2.slice(1), 16);
      const r1 = (c1 >> 16) & 0xff, g1 = (c1 >> 8) & 0xff, b1 = c1 & 0xff;
      const r2 = (c2 >> 16) & 0xff, g2 = (c2 >> 8) & 0xff, b2 = c2 & 0xff;
      const r = Math.round(r1 + factor * (r2 - r1));
      const g = Math.round(g1 + factor * (g2 - g1));
      const b = Math.round(b1 + factor * (b2 - b1));
      return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
    }

    function getFillColor(value, colConfig) {
      const factor = Math.max(0, Math.min(1, (value - colConfig.minValue) / (colConfig.maxValue - colConfig.minValue)));
      return interpolateColor(colConfig.minColor, colConfig.maxColor, factor);
    }

    async function loadData() {
      const geojsonResponse = await fetch("https://kxljxv.github.io/wahlergebnisse/map.json");
      geojsonData = await geojsonResponse.json();
      const csvResponse = await fetch("https://kxljxv.github.io/wahlergebnisse/ergebnisse.csv");
      csvData = (await csvResponse.text()).trim().split("\n").slice(1).map(line => {
        const [id, ...values] = line.split(",");
        return { ID: id.trim(), values: values.map(v => parseFloat(v) || 0) };
      });

      updateMapColors();
      initMap();
    }

    function updateMapColors() {
      geojsonData.features.forEach(feature => {
        const id = feature.properties.ID;
        const csvRow = csvData.find(row => row.ID === id);
        if (csvRow) {
          feature.properties = { ...feature.properties, ...csvRow };
        }
        const key = selectedYear + selectedParty;
        if (columns[key]) {
          const value = feature.properties.values[Object.keys(columns).indexOf(key)];
          feature.properties.fillColor = getFillColor(value, columns[key]);
        } else {
          feature.properties.fillColor = "#cccccc";
        }
      });
      if (map) {
        map.getSource('wahlergebnisse').setData(geojsonData);
      }
    }

    function initMap() {
      map = new maplibregl.Map({
        container: 'map',
        style: 'https://kxljxv.github.io/bm_web_gry_7.json',
        center: [13.4050, 52.5200],
        zoom: 10
      });

      map.on('load', () => {
        map.addSource('wahlergebnisse', { type: 'geojson', data: geojsonData });
        map.addLayer({
          id: 'wahlergebnisse-fill',
          type: 'fill',
          source: 'wahlergebnisse',
          paint: { 'fill-color': ['get', 'fillColor'], 'fill-opacity': 1 }
        });

        map.on('click', 'wahlergebnisse-fill', e => {
          if (e.features.length > 0) {
            const feature = e.features[0];
            selectedFeatureId = feature.properties.ID;
            document.getElementById('selected-id').textContent = "AusgewÃ¤hlte ID: " + selectedFeatureId;
            window.parent.postMessage({ selectedId: selectedFeatureId }, "*");
          }
        });
      });
    }

    window.addEventListener("message", event => {
      if (event.data && event.data.selectedParty && event.data.selectedYear) {
        selectedParty = event.data.selectedParty;
        selectedYear = event.data.selectedYear;
        updateMapColors();
      }
    });

    loadData();
  </script>
</body>
</html>
