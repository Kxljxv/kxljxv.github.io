<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Berlin Wahlergebnisse</title>
    <script src='https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.css' rel='stylesheet' />
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        #district-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            z-index: 1;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="map" class="map"></div>
    <div id="district-info">
        <h3>Wahlergebnisse Berlin</h3>
    </div>

    <script>
        // Konfiguration für Farben und Darstellung
        const COLUMN_CONFIGS = {
            '21AFD': {
                winnerColor: '#0066CC',
                minColor: '#B0C4DE',
                maxColor: '#00008B',
                minValue: 0,
                maxValue: 30,
                displayColor: '#4169E1'
            },
            '25SPD': {
                winnerColor: '#FF0000',
                minColor: '#FFB6C1',
                maxColor: '#8B0000',
                minValue: 0,
                maxValue: 40,
                displayColor: '#FF4500'
            }
            // Weitere Parteien können hier konfiguriert werden
        };

        let map, geojsonSource, csvData;
        let selectedYear = '25', selectedColumn = 'gewinner';

        // MapLibre Initialisierung
        function initMap() {
            map = new maplibregl.Map({
                container: 'map',
                style: 'https://kxljxv.github.io/bm_web_gry_7.json',
                center: [13.404954, 52.520008],
                zoom: 9,
                maxZoom: 14,
                minZoom: 8
            });

            map.addControl(new maplibregl.NavigationControl());
            map.addControl(new maplibregl.GeolocateControl());

            map.on('load', () => {
                Promise.all([
                    fetch('https://kxljxv.github.io/wahlergebnisse/map.json').then(r => r.json()),
                    fetch('https://kxljxv.github.io/wahlergebnisse/ergebnisse.csv').then(r => r.text())
                ]).then(([geojsonData, csvText]) => {
                    csvData = Papa.parse(csvText, { header: true }).data;
                    setupMap(geojsonData);
                }).catch(error => {
                    console.error('Fehler beim Laden der Daten:', error);
                });
            });
        }

        function setupMap(geojsonData) {
            // GeoJSON-Quelle hinzufügen
            map.addSource('berlin-districts', {
                type: 'geojson',
                data: geojsonData
            });

            // GeoJSON-Layer mit Füllfarbe hinzufügen
            map.addLayer({
                id: 'districts-fill',
                type: 'fill',
                source: 'berlin-districts',
                paint: {
                    'fill-color': getPolygonColor,
                    'fill-opacity': 0.7
                }
            }, 'background'); // Wichtig: Layer unter der Basemap hinzufügen

            // Umrandung der Distrikte
            map.addLayer({
                id: 'districts-line',
                type: 'line',
                source: 'berlin-districts',
                paint: {
                    'line-color': [
                        'case', 
                        ['boolean', ['feature-state', 'selected'], false],
                        'black',
                        'transparent'
                    ],
                    'line-width': 2
                }
            });

            map.on('click', 'districts-fill', handleDistrictClick);
        }

        function getPolygonColor(feature) {
            // Grundlegende Farblogik für Polygone
            if (selectedColumn === 'gewinner') {
                // Gewinner-Logik implementieren
                return '#4169E1'; // Temporäre Farbe
            }

            // Für spezifische Spalten Farbverlauf implementieren
            const columnConfig = COLUMN_CONFIGS[selectedYear + selectedColumn];
            if (!columnConfig) return 'lightgray';

            // Dummy-Implementierung für Farbverlauf
            return columnConfig.displayColor;
        }

        function handleDistrictClick(e) {
            const feature = e.features[0];
            const districtId = feature.properties.ID;
            const districtData = csvData.find(row => row.ID === districtId);

            if (districtData) {
                // Alle Features deselektieren
                map.getSource('berlin-districts').setFeatureState(
                    { source: 'berlin-districts' },
                    { selected: false }
                );

                // Aktuelles Feature selektieren
                map.getSource('berlin-districts').setFeatureState(
                    { id: feature.id, source: 'berlin-districts' },
                    { selected: true }
                );

                // Aktualisiere Distrikt-Informationen
                document.getElementById('district-info').innerHTML = `
                    <h3>${districtData.BEZIRK}</h3>
                    <p>Wahlbezirk: ${districtData[selectedYear + 'UWB']}</p>
                `;
            }
        }

        // Initialisierung
        initMap();
    </script>
</body>
</html>
