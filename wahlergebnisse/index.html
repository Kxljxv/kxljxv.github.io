<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Berlin Wahlergebnisse</title>
    <script src="https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
        }
        #container {
            display: flex;
            height: 100vh;
            transition: flex-direction 0.3s ease;
        }
        #map {
            flex-grow: 1;
            position: relative;
        }
        #sidebar {
            width: 400px;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        #district-info {
            margin-bottom: 15px;
        }
        #chart-container {
            flex-grow: 1;
        }
        .landscape-mode {
            flex-direction: row;
        }
        .portrait-mode {
            flex-direction: column;
        }
        .chart-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="container" class="landscape-mode">
        <div id="map"></div>
        <div id="sidebar">
            <div id="district-info">
                <h2 id="district-name">Gesamtergebnis Berlin</h2>
            </div>
            <div id="chart-container">
                <canvas id="results-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Konfiguration für Farben und Darstellung
        const COLUMN_CONFIGS = {
            '21AFD': {
                winnerColor: '#0066CC',
                minColor: '#B0C4DE',
                maxColor: '#00008B',
                minValue: 0,
                maxValue: 30,
                displayColor: '#4169E1'
            },
            // Weitere Parteien hier analog konfigurieren
        };

        let map, geojsonSource, csvData, berlinOverallResults;
        let selectedYear = '25', selectedColumn = 'gewinner';
        let resultsChart;

        // MapLibre Initialisierung
        function initMap() {
            map = new maplibregl.Map({
                container: 'map',
                style: 'https://kxljxv.github.io/bm_web_gry_7.json',
                center: [13.404954, 52.520008],
                zoom: 9,
                maxZoom: 14,
                minZoom: 8
            });

            map.addControl(new maplibregl.NavigationControl());
            map.addControl(new maplibregl.GeolocateControl());

            map.on('load', () => {
                Promise.all([
                    fetch('https://kxljxv.github.io/wahlergebnisse/map.json').then(r => r.json()),
                    fetch('https://kxljxv.github.io/wahlergebnisse/ergebnisse.csv').then(r => r.text())
                ]).then(([geojsonData, csvText]) => {
                    csvData = Papa.parse(csvText, { header: true }).data;
                    setupMap(geojsonData);
                });
            });
        }

        function setupMap(geojsonData) {
            map.addSource('berlin-districts', {
                type: 'geojson',
                data: geojsonData
            });

            map.addLayer({
                id: 'districts-layer',
                type: 'fill',
                source: 'berlin-districts',
                paint: {
                    'fill-color': getPolygonColor,
                    'fill-opacity': 0.7
                }
            });

            map.addLayer({
                id: 'districts-outline',
                type: 'line',
                source: 'berlin-districts',
                paint: {
                    'line-color': 'black',
                    'line-width': [
                        'case',
                        ['boolean', ['feature-state', 'selected'], false],
                        2,
                        0
                    ]
                }
            });

            map.on('click', 'districts-layer', handleDistrictClick);
        }

        function getPolygonColor(feature) {
            // Implementierung der Farblogik basierend auf Wahlergebnissen
            // Detaillierte Logik würde hier stehen
        }

        function handleDistrictClick(e) {
            const feature = e.features[0];
            const districtId = feature.properties.ID;
            const districtData = csvData.find(row => row.ID === districtId);

            if (districtData) {
                updateDistrictInfo(districtData);
                updateChart(districtData);
                
                // Alle Features deselektieren
                map.getSource('berlin-districts').setFeatureState(
                    { source: 'berlin-districts', sourceLayer: 'districts-layer' },
                    { selected: false }
                );

                // Aktuelles Feature selektieren
                map.getSource('berlin-districts').setFeatureState(
                    { id: feature.id, source: 'berlin-districts', sourceLayer: 'districts-layer' },
                    { selected: true }
                );
            }
        }

        function updateDistrictInfo(districtData) {
            document.getElementById('district-name').textContent = 
                `${districtData.BEZIRK} (${selectedYear}UWB: ${districtData[selectedYear + 'UWB']})`;
        }

        function updateChart(districtData) {
            // Chart Update-Logik
        }

        function toggleDisplayMode() {
            const container = document.getElementById('container');
            container.classList.toggle('landscape-mode');
            container.classList.toggle('portrait-mode');
        }

        // Initialisierung
        initMap();
    </script>
</body>
</html>
